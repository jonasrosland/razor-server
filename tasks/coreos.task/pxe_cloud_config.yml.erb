#cloud-config

coreos:
  units:
    - name: etcd.service
      command: start
    - name: fleet.service
      command: start
    - name: format-ephemeral.service
      command: start
      content: |
        [Unit]
        Description=Formats the ephemeral drive
        [Service]
        Type=oneshot
        RemainAfterExit=no
        ExecStart=/usr/sbin/wipefs -f /dev/sda
        ExecStart=/usr/sbin/mkfs.btrfs -f -L ROOT /dev/sda

    - name: download-postinstall.service
      command: start
      content: |
        [Unit]
        After=network-online.target
        Description=Download Razor post_install script
        Documentation=https://github.com/puppetlabs/razor-server
        Requires=network-online.target

        [Service]
        ExecStart=/usr/bin/wget -O /root/post_install.sh <%= file_url("post_install") %>
        ExecStart=/usr/bin/chmod +x /root/post_install.sh
        ExecStart=/root/post_install.sh
        ExecStart=/usr/sbin/reboot
        RemainAfterExit=no
        Type=oneshot

ssh_authorized_keys:
#  - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCltHm3vFFhRun3u2ka6pK7pUVh44jX2vwdCx6R4t6N4HyHWemf9WzGVhjFYupoxYTbtyqkCCKyMFXEFULRVsfRZ/7wl3IPZGsQMXUSDFYaPfhrpkvj8mJbghrSSj2rmlrKKgA2Jl0Y5jXR+W+sCsdnilquh/vWcWcbUlkcGlK0SYrkfVnfsmmSFhSWa56kCz69B35un3CuX4fEWvIW1bhq+6IruB4DewVlfz6pXE4fHUK0oiqlvlv7boLlR4kMoQ+49DjKlRyJdkHZJtaW3RvKBaF6qbTTPC24tETDKs1GIv2tTDmxl1O1RFG5J91kq70yp6KrB+NQ6i/AnLuRmRmF
   - ssh-rsa <%= node.ssh-rsa %>
